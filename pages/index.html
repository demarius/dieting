<html>
<head>
<title>{{title}}</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript"
src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.9.25/paper-core.js"></script>
<script type="text/javascript" src="{{url}}/socket.io/socket.io.js"></script>
<script>
paper.install(window)
window.onload = function () {
    var canvas = document.getElementById('board')
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
    paper.setup(canvas)
    var bandits = []
    var path = new paper.Path(), tool = new Tool(), nativeColor
    var socket = io()

    var nativeDraw = function (ev) {
        path.lineTo(ev.point)
        paper.view.draw()
        path.moveTo(ev.point)
        socket.emit('drawing', {
            move: ev.point,
            color: nativeColor
        })
    }

    var banditDraw = function (ev, color) {
        var bandit = bandits[color]
        bandit.lineTo(ev)
        paper.view.draw()
        bandit.moveTo(ev)
    }

    socket.on('drawing', function (art) {
        if (!bandits.hasOwnProperty(art.color))  {
            bandits[art.color] = new Path()
            bandits[art.color].strokeColor = art.color
            bandits[art.color].moveTo(new Point(50, 50))
        }
        banditDraw(new Point(art.move.slice(1)), art.color)
    })

    $('.welcome button').on('click', function () {
        var username = $('.welcome input').val() || 'anon'
        $('.welcome').remove()
        if (username == 'anon') {
            path.strokeColor = 'black'
            // black, no socket
            path.moveTo(new paper.Point(100, 100))
            tool.onMouseMove = nativeDraw
        } else {
            $.ajax('/user/' + username, {
                data: {
                    username: username
                },
                success: function (data) {
                    nativeColor = data.color // because vv
                    path.strokeColor = data.color // <-- converts to otherness
                    path.moveTo(new paper.Point(50, 50))
                    tool.onMouseMove = nativeDraw
                }
            })
        }
    })
}
</script>
</head>
<body>
    <div class='welcome'>
        <label>Username: <input type="text" name="username" /></label>
        <button>Start</button>
    </div>
    <canvas id="board" resize></canvas>
</body>
</html>
